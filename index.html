<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ClimbSync - –ö–∞–ª–µ–Ω–¥–∞—Ä—å –ü—Ä–æ–ª–∞–∑–æ–≤</title>

<script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isoWeek.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/ru.js"></script>

<style>
:root {
    --bg: #121212;
    --card-bg: #1e1e1e;
    --accent: #bb86fc;
    --text: #e0e0e0;
    --border: #333;
    --success: #4caf50;
}

body {
    font-family: 'Segoe UI', sans-serif;
    background-color: var(--bg);
    color: var(--text);
    margin: 0;
    display: flex;
    justify-content: center;
    min-height: 100vh;
}

.container {
    width: min(100%, 980px);
    padding: 12px;
}

header { text-align: center; margin-bottom: 12px; }

.profile-card {
    background: var(--card-bg);
    padding: 15px;
    border-radius: 12px;
    margin-bottom: 20px;
    border: 1px solid var(--border);
}

input, select {
    background: #2d2d2d;
    border: 1px solid var(--border);
    color: white;
    padding: 8px;
    border-radius: 6px;
    margin: 5px 0;
    width: 100%;
}

button {
    background: var(--accent);
    border: none;
    padding: 10px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
}

.icon-button {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    background: #2a2a2a;
    color: #fff;
    border: 1px solid var(--border);
    padding: 0;
    display: grid;
    place-items: center;
    transition: transform 0.15s ease, border-color 0.15s ease, background 0.15s ease;
}

.icon-button:hover {
    transform: translateY(-1px);
    border-color: var(--accent);
    background: #343434;
}

.icon-button svg {
    width: 18px;
    height: 18px;
}

.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.grid {
    display: grid;
    grid-template-columns: repeat(7, minmax(0, 1fr));
    gap: 4px;
    margin-top: 8px;
}

.calendar-wrap {
    transition: opacity 0.18s ease, transform 0.18s ease;
    opacity: 1;
    transform: translateX(0);
}

.calendar-wrap.animating {
    opacity: 0;
}

.calendar-wrap.slide-left.animating {
    transform: translateX(-10px);
}

.calendar-wrap.slide-right.animating {
    transform: translateX(10px);
}

.weekday {
    text-align: center;
    font-size: 0.8em;
    opacity: 0.6;
}

.day {
    min-height: clamp(64px, 11vw, 92px);
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 5px;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    transition: 0.2s;
}

.gym-icons {
    display: flex;
    flex-wrap: wrap;
    gap: 3px;
}

.gym-icon {
    width: 17px;
    height: 17px;
    border-radius: 50%;
    font-size: 0.52em;
    line-height: 17px;
    text-align: center;
    font-weight: 700;
    color: #fff;
    border: 1px solid rgba(255,255,255,0.15);
}

.day:hover { border-color: var(--accent); }

.day.today {
    border-bottom: 3px solid var(--accent);
}

.day.has-events {
    border-color: var(--success);
}

.count {
    font-size: 0.75em;
    opacity: 0.8;
}

.loader {
    text-align: center;
    margin: 10px 0;
}

#modal, .overlay {
    position: fixed;
}

.overlay {
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.7);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
}

#modal {
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: var(--card-bg);
    padding: 20px;
    border-radius: 15px;
    width: 300px;
    z-index: 10;
    opacity: 0;
    pointer-events: none;
    transform: translate(-50%, -45%) scale(0.97);
    transition: transform 0.2s ease, opacity 0.2s ease;
}

.overlay.open {
    opacity: 1;
    pointer-events: auto;
}

#modal.open {
    opacity: 1;
    pointer-events: auto;
    transform: translate(-50%, -50%) scale(1);
}

.visit-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
    margin-bottom: 6px;
    font-size: 0.94em;
}

.delete-btn {
    background: #b12e2e;
    color: #fff;
    padding: 5px 8px;
    font-size: 0.75em;
}

.success-message {
    color: var(--success);
    font-size: 0.85em;
}
</style>
</head>

<body>

<div class="container">
<div class="profile-card">
<h3>–¢–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h3>
<input type="text" id="userName" placeholder="–ò–º—è">
<button onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div>

<div class="calendar-header">
<button class="icon-button" onclick="changeMonth(-1)" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∏–π –º–µ—Å—è—Ü">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
</button>
<h2 id="monthTitle"></h2>
<button class="icon-button" onclick="changeMonth(1)" aria-label="–°–ª–µ–¥—É—é—â–∏–π –º–µ—Å—è—Ü">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l6-6-6-6"/></svg>
</button>
</div>

<div id="calendarWrap" class="calendar-wrap">
    <div id="calendar" class="grid"></div>
</div>
<div id="loader" class="loader">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

</div>

<div class="overlay" id="overlay" onclick="closeModal()"></div>

<div id="modal">
<h3 id="modalDateTitle"></h3>
<div id="visitsList"></div>
<hr>
<select id="gymSelect">
<option>Bigwall –î–∏–Ω–∞–º–æ</option>
<option>Bigwall –ì–∞–≤–∞–Ω—å</option>
<option>Bigwall –†–∏–≤—å–µ—Ä–∞</option>
<option>ClimbLab –ë—É—Ç—ã—Ä—Å–∫–∞—è</option>
<option>ClimbLab –ê–º–∏–Ω—å–µ–≤—Å–∫–∞—è</option>
<option>Tengu's –ú–∏—á—É—Ä–∏–Ω—Å–∫–∏–π</option>
<option>Tengu's –Æ–∂–Ω–∞—è</option>
<option>Limestone</option>
<option>Rockzona</option>
<option>Tokyo</option>
<option>–¶–°–ö–ê</option>
</select>
<input type="time" id="visitTime" value="19:00">
<button onclick="submitVisit()">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è</button>
<div id="submitStatus"></div>
</div>

<script>
dayjs.extend(window.dayjs_plugin_isoWeek);
dayjs.locale('ru');

const API_URL = 'https://script.google.com/macros/s/AKfycbywsHJJz9FzGV3J3G_02MR1UAyTGdT6ldqVto82zJbSFF4C2snqAZWAH2q_kpaFbp0C/exec';

let currentMonth = dayjs();
let events = [];
let selectedDate = '';

const gymMeta = {
    'Bigwall –î–∏–Ω–∞–º–æ': { icon: 'BW', color: '#2d4f9e' },
    'Bigwall –ì–∞–≤–∞–Ω—å': { icon: 'BW', color: '#2d4f9e' },
    'Bigwall –†–∏–≤—å–µ—Ä–∞': { icon: 'BW', color: '#2d4f9e' },
    'ClimbLab –ë—É—Ç—ã—Ä—Å–∫–∞—è': { icon: 'CL', color: '#111111' },
    'ClimbLab –ê–º–∏–Ω—å–µ–≤—Å–∫–∞—è': { icon: 'CL', color: '#111111' },
    "Tengu's –ú–∏—á—É—Ä–∏–Ω—Å–∫–∏–π": { icon: 'Â§©', color: '#c82424' },
    "Tengu's –Æ–∂–Ω–∞—è": { icon: 'Â§©', color: '#c82424' },
    'Limestone': { icon: 'LS', color: '#d7b221' },
    'Rockzona': { icon: 'RZ', color: '#4f86ff' },
    'Tokyo': { icon: 'TK', color: '#2fa88e' },
    '–¶–°–ö–ê': { icon: '‚õ∞', color: '#4f9633' }
};

document.getElementById('userName').value = localStorage.getItem('climberName') || '';

function escapeHTML(str) {
    return str.replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
    }[m]));
}

function saveProfile() {
    localStorage.setItem('climberName', document.getElementById('userName').value);
    alert('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
}

async function fetchData() {
    try {
        document.getElementById('loader').style.display = 'block';
        const res = await fetch(API_URL);
        const rawData = await res.json();
        events = normalizeEvents(rawData);
        renderCalendar();
    } catch (e) {
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
    } finally {
        document.getElementById('loader').style.display = 'none';
    }
}

function normalizeEvents(rawData) {
    if (!Array.isArray(rawData)) return [];

    if (rawData.length > 0 && !Array.isArray(rawData[0])) {
        return rawData
            .filter(item => item && item.date && item.name)
            .map(item => ({
                ...item,
                date: normalizeDate(item.date),
                time: normalizeTime(item.time),
                row: item.row || item.id || null
            }))
            .filter(item => item.date);
    }

    return rawData
        .map((row, index) => ({ row, sourceRow: index + 1 }))
        .filter(({ row }) => Array.isArray(row) && row.length >= 4)
        .map(({ row, sourceRow }) => {
            const [date, name, gym, time] = row;
            return {
                row: sourceRow,
                date: normalizeDate(date),
                name: String(name || ''),
                gym: String(gym || ''),
                time: normalizeTime(time)
            };
        })
        .filter(item => item.date && item.name);
}

function normalizeDate(input) {
    if (!input) return '';
    const parsed = dayjs(input);
    return parsed.isValid() ? parsed.format('YYYY-MM-DD') : '';
}

function normalizeTime(input) {
    if (input == null || input === '') return '';
    const raw = String(input).trim();
    if (/^\d{2}:\d{2}$/.test(raw)) return raw;
    const parsed = dayjs(input);
    if (parsed.isValid() && parsed.year() > 1900) return parsed.format('HH:mm');
    const isoTime = raw.match(/T(\d{2}:\d{2})/);
    if (isoTime) return isoTime[1];
    return raw;
}

function renderGymIcons(dayEvents) {
    const uniqueGyms = [...new Set(dayEvents.map(item => item.gym))].slice(0, 4);
    return `<div class="gym-icons">${uniqueGyms.map(gym => {
        const meta = gymMeta[gym] || { icon: '‚Ä¢', color: '#696969' };
        return `<span class="gym-icon" title="${escapeHTML(gym)}" style="background:${meta.color}">${escapeHTML(meta.icon)}</span>`;
    }).join('')}</div>`;
}

function renderCalendar() {
    const calendar = document.getElementById('calendar');
    calendar.innerHTML = '';

    document.getElementById('monthTitle').innerText =
        currentMonth.format('MMMM YYYY').replace(/^./, m => m.toUpperCase());

    const weekdays = ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'];
    weekdays.forEach(d => {
        calendar.innerHTML += `<div class="weekday">${d}</div>`;
    });

    const startOffset = currentMonth.startOf('month').isoWeekday() - 1;
    const daysInMonth = currentMonth.daysInMonth();

    for (let i=0;i<startOffset;i++) {
        calendar.innerHTML += `<div></div>`;
    }

    for (let d=1; d<=daysInMonth; d++) {
        const dateStr = currentMonth.date(d).format('YYYY-MM-DD');
        const dayEvents = events.filter(e => e.date === dateStr);

        const isToday = dayjs().format('YYYY-MM-DD') === dateStr;

        calendar.innerHTML += `
        <div class="day ${isToday?'today':''} ${dayEvents.length?'has-events':''}"
            onclick="openModal('${dateStr}')">
            <div>${d}</div>
            ${dayEvents.length ? renderGymIcons(dayEvents) : '<div></div>'}
            <div class="count">${dayEvents.length ? dayEvents.length + ' üë•' : ''}</div>
        </div>`;
    }
}

function openModal(date) {
    selectedDate = date;
    document.getElementById('modalDateTitle').innerText =
        dayjs(date).format('DD MMMM YYYY');

    const dayEvents = events.filter(e => e.date === date);

    document.getElementById('visitsList').innerHTML =
        dayEvents.length
        ? dayEvents.map(e =>
            `<div class="visit-item"><div><b>${escapeHTML(e.name)}</b> ‚Äì ${escapeHTML(e.gym)}${e.time ? ` (${escapeHTML(e.time)})` : ''}</div>
                <button class="delete-btn" onclick="deleteVisit(${Number(e.row) || 'null'})">–£–¥–∞–ª–∏—Ç—å</button></div>`
          ).join('')
        : '–ü–æ–∫–∞ –Ω–∏–∫—Ç–æ –Ω–µ –∑–∞–ø–∏—Å–∞–ª—Å—è';

    document.getElementById('overlay').classList.add('open');
    document.getElementById('modal').classList.add('open');
}

function closeModal() {
    document.getElementById('overlay').classList.remove('open');
    document.getElementById('modal').classList.remove('open');
    document.getElementById('submitStatus').innerHTML = '';
}

document.addEventListener('keydown', e=>{
    if(e.key==='Escape') closeModal();
});

async function submitVisit() {
    const name = localStorage.getItem('climberName');
    if (!name) return alert('–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏ –∏–º—è');

    const newEvent = {
        date: selectedDate,
        name,
        gym: document.getElementById('gymSelect').value,
        time: document.getElementById('visitTime').value
    };

    const status = document.getElementById('submitStatus');
    status.innerHTML = '–û—Ç–ø—Ä–∞–≤–∫–∞...';

    try {
        const res = await fetch(API_URL, {
            method: 'POST',
            headers: {'Content-Type': 'text/plain;charset=utf-8'},
            body: JSON.stringify(newEvent)
        });

        if (!res.ok) throw new Error();

        status.innerHTML = '<div class="success-message">–ó–∞–ø–∏—Å–∞–Ω–æ ‚úÖ</div>';
        await fetchData();
        setTimeout(closeModal, 800);

    } catch {
        status.innerHTML = '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏';
    }
}

async function deleteVisit(row) {
    if (!row) return;
    const status = document.getElementById('submitStatus');
    status.innerHTML = '–£–¥–∞–ª–µ–Ω–∏–µ...';
    try {
        const res = await fetch(API_URL, {
            method: 'POST',
            headers: {'Content-Type': 'text/plain;charset=utf-8'},
            body: JSON.stringify({ action: 'delete', row })
        });

        if (!res.ok) throw new Error();

        status.innerHTML = '<div class="success-message">–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞ ‚úÖ</div>';
        await fetchData();
        openModal(selectedDate);
    } catch {
        status.innerHTML = '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è';
    }
}

function changeMonth(step) {
    const wrap = document.getElementById('calendarWrap');
    wrap.classList.remove('slide-left', 'slide-right');
    wrap.classList.add(step > 0 ? 'slide-left' : 'slide-right', 'animating');

    currentMonth = currentMonth.add(step, 'month');
    setTimeout(() => {
        renderCalendar();
        wrap.classList.remove('animating');
    }, 120);
}

fetchData();
</script>

</body>
</html>
