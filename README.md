# Rock Climbing Calendar

## Линк на прод: https://anyalink99.github.io/rockclimbingcalendar.github.io/

## Что это

Приложение состоит из **двух независимых частей**:

1. **Календарь записей на скалодромы** (визиты).
2. **Чат**.

Они живут на одной странице, но архитектурно и по данным разделены.

---

## Важное про бэкенды и таблицы

В проекте специально используются **два разных backend-файла**, **две разные таблицы**, и **два разных Apps Script endpoint-а**:

- `backend.gs` — бэкенд календаря записей.
- `backend_chat.gs` — бэкенд чата.

Это **не один общий API**. Логика не смешана:

- календарь работает только со своими данными и своей таблицей;
- чат работает только со своими данными и своей таблицей;
- между ними нет общего хранилища и нет прямых вызовов друг друга.

---

## Текущая структура фронтенда

```text
scripts/
  common/
    core.js                # общие утилиты (escapeHtml, имя пользователя, dayjs init)

  calendar/
    config.js              # константы календаря, DOM refs, state
    data.js                # нормализация/кеш/API для записей
    ui.js                  # тема, кастомные select, модальное окно
    render.js              # рендер календаря и списка визитов
    controller.js          # пользовательские действия, sync, инициализация

  chat/
    config.js              # константы чата, DOM refs, state
    data.js                # загрузка, JSONP fallback, кеш, merge optimistic/server
    view.js                # рендер сообщений
    controller.js          # open/close/send/sync/scroll + mobile keyboard behavior

  app.js                   # bootstrap календаря
  chat.js                  # bootstrap чата
```

---

## Как работает календарь (кратко)

- При старте: читается локальный кеш записей, затем подтягивается снимок с сервера.
- Данные нормализуются (`date/time/unsure`) и снабжаются fingerprint для сравнения.
- Поддерживается optimistic UI:
  - новая запись сразу появляется локально;
  - удаление сразу отражается локально;
  - далее sync с сервером примиряет состояние.
- Есть suppression «повторных анимаций» для уже отрисованных элементов.

---

## Как работает чат (кратко)

- При старте: загружается кеш сообщений, затем обновление с сервера по таймеру.
- Для чтения используется `fetch`, и при проблемах — JSONP fallback.
- Для отправки используется optimistic сообщение (локально сразу), потом reconciliation с сервером.
- Для уже локально отображённых сообщений повторная анимация не проигрывается.
- Для мобильных устройств добавлен учёт `visualViewport`: при открытии клавиатуры чат и кнопка поднимаются вверх, чтобы не прятать нижнюю часть переписки.

---

## Локальный запуск

Статически:

```bash
python3 -m http.server 4173
```

Открыть: `http://localhost:4173`
